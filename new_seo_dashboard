with visits as (
    select
       date(v.startDate) as date, 
       v.countrycode,
       initcap(v.rxaudience) as role,
       case when lower(v.device) = 'smartphone' then 'mobile' 
            when ( v.device = '' or v.device is null ) then 'mobile' 
         else lower(v.device) end as device,
       case when lower(v.rxservice) = 'homecare' then 'housekeeping' else lower(v.rxservice) end as vertical,     
       case when lower(v.rxcreativeversion) like '%?refh%' then 'magazine-article' else lower(v.rxcampaignname) end as page_type,     
       count(distinct v.visitorid) as visits, 
       count(distinct case when (v.memberid is null or v.signup = true) then v.visitorid end) as non_member_visits,
       count(distinct enr.visitorid) as reached_enrollment   
    from intl.hive_visit v
    left join intl.hive_event enr   on enr.countrycode = v.countrycode and enr.visitorid = v.visitorid and enr.datecreated > v.startDate
                                    and enr.name = 'PageView' and (enr.currentpageurl like '%join-now%' or enr.currentpageurl like '%register%') 
                                    and enr.year >= year(now())-2 and date(enr.datecreated) < date(current_date)
    where lower(v.rxcampaign) = 'seo'  
      and (v.rxcampaignname <> '' or lower(v.rxcreativeversion) like '%?refh%')
      and v.year >= year(now())-2
      and date(v.startDate) < date(current_date)
    group by 1,2,3,4,5,6 
),

basics as (
    select 
       date(dateMemberSignup) as date,
       countrycode,
       lower(role) as role,
       case when lower(device) = 'smartphone' then 'mobile' 
            when ( device = '' or device is null ) then 'mobile' 
         else lower(device) end as device,
       case when lower(service) = 'homecare' then 'housekeeping' else lower(service) end as vertical, 
       case when lower(creativeversion) like '%?refh%' then 'magazine-article' else lower(campaignname) end as page_type,
       count(distinct memberid) as basics
    from intl.hive_member
    where year(dateMemberSignup) >= year(now())-2
      and lower(campaign) = 'seo'
      and (campaignname <> '' or creativeversion like '%?refh%')
      and isinternalaccount = 'false'
      and role <> ''
      and service <> ''
    group by 1,2,3,4,5,6
),

premiums as (
    select
      date(s.subscriptionDateCreated) as date,
      m.countrycode,
      lower(m.role) as role,
      case when lower(m.device) = 'smartphone' then 'mobile' 
           when ( m.device = '' or m.device is null ) then 'mobile' 
         else lower(m.device) end as device,
      case when lower(m.service) = 'homecare' then 'housekeeping' else lower(m.service) end as vertical, 
      case when lower(m.creativeversion) like '%?refh%' then 'magazine-article' else lower(m.campaignname) end as page_type,
      count(distinct case when date(m.dateFirstPremiumSignup)  = date(s.subscriptionDateCreated) and date(m.dateFirstPremiumSignup) = date(m.datemembersignup) then s.subscriptionId end) as day1s,
      count(distinct case when date(m.dateFirstPremiumSignup)  = date(s.subscriptionDateCreated) and date(m.dateFirstPremiumSignup) <> date(m.datemembersignup) then s.subscriptionId end) as nths,
      count(distinct case when date(m.dateFirstPremiumSignup) != date(s.subscriptionDateCreated) then s.subscriptionId end) as reupgrades   
    from intl.transaction t
      join intl.hive_subscription_plan s  on s.subscriptionId = t.subscription_plan_id and s.countrycode = t.country_code   
      join intl.hive_member m             on t.member_id = m.memberid and t.country_code = m.countrycode
    where t.type in ('PriorAuthCapture','AuthAndCapture')
      and t.status = 'SUCCESS' 
      and t.amount > 0 
      and year(s.subscriptionDateCreated) >= year(now())-2
      and lower(m.campaign) = 'seo'
      and (m.campaignname <> '' or m.creativeversion like '%?refh%')
      and m.role <> ''
      and m.service <> ''
      and m.IsInternalAccount = 'false'
    group by 1,2,3,4,5,6  
)

select 
  coalesce(v.date, b.date, p.date) as date,
  coalesce(v.countrycode, b.countrycode, p.countrycode) as country,
  coalesce(v.role, b.role, p.role) as role,
  coalesce(v.device, b.device, p.device) as device,
  coalesce(v.vertical, b.vertical, p.vertical) as vertical,
  coalesce(v.page_type, b.page_type, p.page_type) as page_type,
  ifnull(sum(v.visits),0) as visits,
  ifnull(sum(v.non_member_visits),0) as non_member_visits,
  ifnull(sum(v.reached_enrollment),0) as reached_enrollment,
  ifnull(sum(b.basics),0) as basics,
  ifnull(sum(p.day1s),0) as day1s,
  ifnull(sum(p.nths),0) as nths,
  ifnull(sum(p.reupgrades),0) as reupgrades
from visits v
full outer join basics b    on v.date = b.date and v.countrycode = b.countrycode and v.role = b.role and v.device = b.device and v.vertical = b.vertical and v.page_type = b.page_type
full outer join premiums p  on v.date = p.date and v.countrycode = p.countrycode and v.role = p.role and v.device = p.device and v.vertical = p.vertical and v.page_type = p.page_type                            
group by 1,2,3,4,5,6
  
