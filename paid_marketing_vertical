with spend as (

-- SEM 
  select distinct
     d.year, d.month, d.date,  
     initcap(sm.campaign_type) as role, 'SEM' as category, 
     case when source_type <> 'GDN' and source <> 'YT' then 'SEM' 
          when source_type = 'GDN' then 'GDN'
          when source = 'YT' then 'YouTube'
      end as channel,   
     case when (source_type = 'GDN' or source = 'YT') then 'Brand'
          when sm.vertical is null then 'Brand' 
          when sm.vertical = 'HomeCare' then 'Housekeeping'     
        else initcap(sm.vertical) end as vertical,
     upper(sm.country) as country, sm.currency,
     sum(sm.cost) as spend
  from intl.dw_f_campaign_spend_intl sm
    join reporting.DW_D_DATE d on date(sm.date) = d.date
  where d.year >= year(now())-1 
    and d.date < date(current_date)
    and sm.country is not null
  group by 1,2,3,4,5,6,7,8,9
  
union

-- FACEBOOK
  select distinct
    d.year, d.month, d.date,
    initcap(campaign_Type) as role, 'Social' as category, 'Facebook' as channel,
    case when vertical = 'Child Care' then 'Childcare'
         when vertical = 'PetCare' then 'Petcare'
         when vertical = 'HouseKeeping' then 'Housekeeping'
         when vertical = 'Turtoring' then 'Tutoring'
         when vertical = 'other' then 'Other' 
      end as vertical, 
    case when upper(country) = 'EN' then 'CA' 
         when upper(country) = '_'  then 'AU' 
         when upper(country) = 'VE'  then 'DE' 
      else upper(country) end as country, 
    fb.currency,
    ifnull(sum(spend),0) as spend
  from intl.DW_F_FACEBOOK_SPEND_INTL fb
    join reporting.DW_D_DATE d on date(date_start) = d.date
  where d.year >= year(now())-1
    and d.date < date(current_date)
  group by 1,2,3,4,5,6,7,8,9
  
union

-- QUALITY CLICK (Seekers)
  select distinct
    year, month, date,
    role, category, channel, vertical,
    country, currency,
    sum(spend) as spend
  from 
      (select distinct
        d.year, d.month, d.date,
       'Seeker' as role, 'Other Online / Affiliate' as category, 'Quality Click' as channel,  
        case when partnerid = '372' then 'Childcare'
             when partnerid in ('469', '472') then 'Housekeeping'
             when partnerid in ('17', '480') then 'Petcare'
           else 'Other' end as vertical,
        case when program in ('DE', 'AT', 'CH') then program
              when product like '%FR%' then 'FR'
              when product like '%BE_nl%' then 'BE'  
              when product like '%BE_fr%' then 'FB'  
              when product like '%DK%' then 'DK'  
              when product like '%FI%' then 'FI'  
              when product like '%NL%' then 'NL'  
              when product like '%SE%' then 'SE'  
              when product like '%IE%' then 'IE'  
              when product like '%ES%' then 'ES'  
              when product like '%AU%' then 'AU'  
              when product like '%NO%' then 'NO'
              when product like '%NZ%' then 'NZ'
              when product like '%UK%' then 'UK'
              when product like '%CA%' then 'CA'
         end as country, 
        'EUR' as currency,
         sum(qc.commission) as spend
      from intl.quality_click_spend qc
        join reporting.DW_D_DATE d on date(day) = d.date
      where partnerid<>435
        and (lower(product) not like '%alltagshelfer%' or lower(product) not like '%provider%') -- Assigned default to seekers as discussed with Fabian
        and d.year >= year(now())-1
        and d.date < date(current_date)
      group by 1,2,3,4,5,6,7,8,9) qc
  group by 1,2,3,4,5,6,7,8,9
  
union

-- PUTZCHECKER (DE Seekers)
  select 
    d.year, d.month, d.date,
    'Seeker' as role, 'Other Online / Affiliate' as category, 
    'Putzchecker' as channel, 'Housekeeping' as vertical, 
    'DE' as country, 'EUR' as currency,
    ifnull((sum(clicks)*1.5),0) as spend
  from intl.quality_click_cpc
    join reporting.DW_D_DATE d on date(day) = d.date
  where d.year >= year(now())-1
    and d.date < date(current_date)
  group by 1,2,3,4,5,6,7,8,9
  
union

-- MIBABY (DE Seekers)
  select distinct d.year, d.month, d.date, 'Seeker' as role, 'Other Online / Affiliate' as category, 'MiBaby' as channel, 'Childcare' as vertical, 'DE' as country, 'EUR' as currency, ifnull(sum(DE_Seeker_Mibaby),0) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on spend_date = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9 

union

-- AWIN
  select distinct
    d.year, d.month, d.date,
    case when aw.commission_group_code in ('REG_P','REGP') then 'Provider' else 'Seeker' end as role,
    'Other Online / Affiliate' as category, 'Awin' as channel, 'Other' as vertical,  
    case when advertiser_id = '10557' then 'DE'
         when advertiser_id = '10709' then 'AT'   
         when advertiser_id = '45671' then 'UK' 
      end as countrycode,  
  	case when advertiser_id in ('10557', '10709') then 'EUR' else 'GBP' end as currency,	   
    ifnull((sum(aw.commission_amount)*1.3),0) as spend
  from intl.awin_spend aw
    join reporting.DW_D_DATE d on date(aw.transaction_Date) = d.date
  where d.year >= year(now())-1
      and d.date < date(current_date)
      and lower(aw.commissionStatus) in ('approved', 'pending')
	group by 1,2,3,4,5,6,7,8,9
	
union

-- MEINESTADT (DE Seekers)
  select distinct
     d.year, d.month, d.date,
     'Seeker' as role, 'Other Online / Affiliate' as category, 'Meinestadt' as channel, vertical, 'DE' as country, 'EUR' as currency,
     sum(case when spend.year = spend.current_year and spend.month = spend.current_month then ((spend)/current_days) else ((spend)/days_in_month) end) as spend
  from (
    select distinct
      year(sp.subscriptionDateCreated) as year,
      month(sp.subscriptionDateCreated) as month,
      date_part('day', last_day(sp.subscriptionDateCreated)) as days_in_month,
      date_part('day', current_date()-1) as current_days,
      month(current_date()-1) as current_month,
      year(current_date()-1) as current_year,
      case when lower(m.service) in ('br', 'all') then 'Brand'
           when (lower(m.service) not in ('br', 'all') and m.vertical = 'homeCare') then 'Housekeeping' 
           when (lower(m.service) not in ('br', 'all') and (m.vertical is null or m.vertical = '')) then 'Childcare' 
        else initcap(lower(m.vertical)) end as vertical,
      count(distinct sp.subscriptionId) as premiums,
      case when count(distinct sp.subscriptionId)<=150 then (count(distinct sp.subscriptionId)*80) 
        when count(distinct sp.subscriptionId)>150 then (150*80)+((count(distinct sp.subscriptionId)-150)*120) end as 'Spend' 
    from intl.transaction t
      join intl.hive_subscription_plan sp on sp.subscriptionId = t.subscription_plan_id and sp.countrycode = t.country_code
        and year(sp.subscriptionDateCreated) >= year(current_date()) and date(sp.subscriptionDateCreated) < current_date()
      join intl.hive_member m on t.member_id = m.memberid and t.country_code = sp.countrycode and date(m.dateFirstPremiumSignup) = date(sp.subscriptionDateCreated)
        and m.IsInternalAccount is not true
        and lower(m.role) = 'seeker' and lower(m.audience) = 'seeker'
        and lower(m.campaign) = 'online' and lower(m.site) = 'meinestadt.de' 
    where t.type in ('PriorAuthCapture','AuthAndCapture') and t.status = 'SUCCESS' and t.amount > 0
      and t.country_code = 'de'      
      and year(t.date_created) >= year(now())-1 and date(t.date_created) < date(current_date)
    group by 1,2,3,4,5,6,7
  ) spend
    join reporting.DW_D_DATE d on spend.year = d.year and spend.month = d.month and d.date < date(current_date)
    group by 1,2,3,4,5,6,7,8,9
      
union   

-- PINTEREST (DE, UK, CA + AU Seekers)
  select distinct d.year, d.month, d.date, 'Seeker' as role, 'Social' as category, 'Pinterest' as channel, 'Childcare' as vertical, 'DE' as country, 'EUR' as currency, sum(DE_Seeker_Pinterest) as spend 
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on spend_date = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9 
  union
  select distinct d.year, d.month, d.date, 'Seeker' as role, 'Social' as category, 'Pinterest' as channel, 'Childcare' as vertical, 'UK' as country, 'EUR' as currency, sum(UK_Seeker_Pinterest) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on spend_date = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9 
  union
  select distinct d.year, d.month, d.date, 'Seeker' as role, 'Social' as category, 'Pinterest' as channel, 'Childcare' as vertical, 'CA' as country, 'EUR' as currency, sum(CA_Seeker_Pinterest) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on spend_date = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9 
  union
  select distinct d.year, d.month, d.date, 'Seeker' as role, 'Social' as category, 'Pinterest' as channel, 'Childcare' as vertical, 'AU' as country, 'EUR' as currency, sum(AU_Seeker_Pinterest) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on spend_date = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9

union

-- IMPACT (CA SEEKERS ONLY)
  select distinct d.year, d.month, d.date, 'Seeker' as role, 'Other Online / Affiliate' ascategory, 'Impact' as channel, 'Other' as vertical, 'CA' as country, 'EUR' as currency, sum(CA_OTHER_ONLINE) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on spend_date = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9  
  
union

-- QUALITY CLICK (Providers)
  select distinct
    year, month, date,
    role, category, channel, vertical, country, currency,
    sum(spend) as spend_domestic_currency
  from 
      (select distinct
        d.year, d.month, d.date,
       'Provider' as role, 'Other Online / Affiliate' as category, 'QualityClick' as channel, 
       case when partnerid = '372' then 'Childcare'
             when partnerid in ('469', '472') then 'Housekeeping'
             when partnerid in ('17', '480') then 'Petcare'
           else 'Other' end as vertical,    
        case when program in ('DE', 'AT', 'CH') then program
              when product like '%FR%' then 'FR'
              when product like '%BE_nl%' then 'BE'  
              when product like '%BE_fr%' then 'FB'  
              when product like '%DK%' then 'DK'  
              when product like '%FI%' then 'FI'  
              when product like '%NL%' then 'NL'  
              when product like '%SE%' then 'SE'  
              when product like '%IE%' then 'IE'  
              when product like '%ES%' then 'ES'  
              when product like '%AU%' then 'AU'  
              when product like '%NO%' then 'NO'
              when product like '%NZ%' then 'NZ'
              when product like '%UK%' then 'UK'
              when product like '%CA%' then 'CA'
         end as country, 
        'EUR' as currency,
         (sum(qc.commission) + sum(qc.currency)) as spend
      from intl.quality_click_spend qc
        join reporting.DW_D_DATE d on date(day) = d.date
      where partnerid<>435
        and (lower(product) like '%alltagshelfer%' or lower(product) like '%provider%') 
        and d.year >= year(now())-1
        and d.date < date(current_date)
      group by 1,2,3,4,5,6,7,8,9) qc
  group by 1,2,3,4,5,6,7,8,9

union 

-- RECRUITICS (Providers)
  select distinct
    d.year, d.month, d.date, 
    'Provider' as role, 'Other Online / Affiliate' as category, 'Recruitics' as channel, 'Other' as vertical,
    case when rc.country in ('DE','') then 'DE' 
         when rc.country = 'GB' then 'UK'
        else rc.country end as country, 
    'EUR' as currency,
    sum(rc.spend) as spend
  from intl.recruitics_spend_intl rc
    join reporting.DW_D_DATE d on date(rc.day) = d.date 
  where lower(rc.source) not in ('xxx','jobg8','jobg8auto','jobtome')
    and d.year >= year(now())-1
    and d.date < date(current_date)
    and date(d.date) < date(current_date)
  group by 1,2,3,4,5,6,7,8,9
  
union

-- RECRUITICS FEE (DE Providers Only)
select 
  d.year, d.month, d.date,
  'Provider' as role, 'Other Online / Affiliate' as category, 'Recrutics' as channel, 'Other' as vertical, 'DE' as country, currency,
  sum(case when rc_fee.year = rc_fee.current_year and rc_fee.month = rc_fee.current_month then ((commission)/current_days) else ((commission)/days_in_month) end) as spend
from
    (select 
      year(rc.day) as year,
      month(rc.day) as month,
      month(current_date()-1) as current_month,
      year(current_date()-1) as current_year,
      date_part('day', last_day(rc.day)) as days_in_month,
      date_part('day', current_date()-1) as current_days,
      currency,
      case when sum(spend) < '20000' then '2500'
           when sum(spend) between '20000' and '30000' then '3000'
           when sum(spend) between '30000' and '50000' then '3600'
           when sum(spend) between '50000' and '80000' then '5000'
           when sum(spend) > '80000' then '8000'
        else '3500' end as commission 
    from intl.recruitics_spend_intl rc
    where year(rc.day) >= year(now())-1
      and lower(source) not in ('xxx','jobg8','jobg8auto','jobtome')
    group by 1,2,3,4,5,6,7) rc_fee
join reporting.DW_D_DATE d on rc_fee.year = d.year and rc_fee.month = d.month and d.date < date(current_date)
group by 1,2,3,4,5,6,7,8,9

union

-- STUDENT JOB (Providers)
  select distinct
    d.year, d.month, d.date,
    'Provider' as role, 'Other Online / Affiliate' as category, 'StudentJob' as channel, 'Other' as vertical,
    case when program in ('DE', 'AT', 'CH') then program
         when product like '%FR%' then 'FR'
         when product like '%BE_nl%' then 'BE'  
         when product like '%BE_fr%' then 'FB'  
         when product like '%DK%' then 'DK'  
         when product like '%FI%' then 'FI'  
         when product like '%NL%' then 'NL'  
         when product like '%SE%' then 'SE'  
         when product like '%IE%' then 'IE'  
         when product like '%ES%' then 'ES'  
         when product like '%AU%' then 'AU'  
         when product like '%NO%' then 'NO'
         when product like '%NZ%' then 'NZ'
         when product like '%UK%' then 'UK'
         when product like '%CA%' then 'CA'
       end as country,
      'EUR' as currency,                 
    sum(case when qc.program='DE' and d.year <= 2022 then qc.count*2 
             when qc.program='DE' and d.year > 2022 then qc.count*3.5 
             when qc.product like '%SE%' and d.year <= 2022 then qc.count*2 
             when qc.product like '%SE%' and d.year > 2022 then qc.count*4
             when qc.product like '%UK%' and d.year <= 2022 then qc.count*1.5
             when qc.product like '%UK%' and d.year > 2022 then qc.count*3
             when qc.product like '%NL%' then qc.count*3.5 
             when qc.product like '%BE_nl%' and d.date < '2022-05-01' then qc.count*1.5
             when qc.product like '%BE_nl%' and d.date >= '2022-05-01' then  qc.count*3.5
         else qc.count*1 end) as spend      
  from intl.quality_click_spend qc
    join reporting.DW_D_DATE d on date(day) = d.date     
  where partnerid = 435
    and (product like '%Alltagshelfer%' or product like '%Provider%')
    and d.year >= year(now())-1 
    and d.date < date(current_date)
  group by 1,2,3,4,5,6,7,8,9 

union 

-- APP JOBS (Providers)
  select distinct
    d.year, d.month, d.date,
    'Provider' as role, 'Other Online / Affiliate' as category, 'AppJobs' as channel, 'Other' as vertical,
    case when country = 'Germany' then 'DE'
         when country = 'Canada' then 'CA' 
       end as country, 
    'EUR' as currency,
    sum(total_spent_usd) as spend          
  from intl.appjobs_spend aj
    join reporting.DW_D_DATE d on date(day) = d.date
  where d.year >= year(now())-1
    and d.date < date(current_date)
  group by 1,2,3,4,5,6,7,8,9 
  
union

-- APPCAST (DE + UK Providers) 
  select distinct d.year, d.month, d.date, 'Provider' as role, 'Other Online / Affiliate' as category, 'AppCast' as channel, 'Other' as vertical, 'DE' as country, 'EUR' as currency, ifnull(sum(de_provider_appcast),0) as spend 
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on spend_date = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9 
  union
  select distinct d.year, d.month, d.date, 'Provider' as role, 'Other Online / Affiliate' as category, 'AppCast' as channel, 'Other' as vertical, 'UK' as country, 'GBP' as currency, ifnull(sum(uk_provider_appcast),0) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on spend_date = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9

union 

-- MY PERFECT JOB (DE Providers)
  select distinct d.year, d.month, d.date, 'Provider' as role, 'Other Online / Affiliate' as category, 'MyPerfectJob' as channel, 'Other' as vertical, 'DE' as country, 'EUR' as currency,ifnull(sum(DE_Provider_Myperfectjob),0) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on date(spend_date) = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9
  
union

-- JOB LIFT (DE Providers)
  select distinct d.year, d.month, d.date, 'Provider' as role, 'Other Online / Affiliate' as category, 'JobLift' as channel, 'Other' as vertical, 'DE' as country, 'EUR' as currency,ifnull(sum(DE_PROVIDER_JOBLIFT),0) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on date(spend_date) = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9
  
union

-- ALLESKRALLE (DACH Providers)
  select distinct d.year, d.month, d.date, 'Provider' as role, 'Other Online / Affiliate' as category, 'AllesKralle' as channel, 'Other' as vertical, 'DE' as country, 'EUR' as currency,ifnull(sum(DE_PROVIDER_ALLESKRALLE),0) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on date(spend_date) = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9
  union
  select distinct d.year, d.month, d.date, 'Provider' as role, 'Other Online / Affiliate' as category, 'AllesKralle' as channel, 'Other' as vertical, 'AT' as country, 'EUR' as currency,ifnull(sum(AT_PROVIDER_ALLESKRALLE),0) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on date(spend_date) = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9
  union
  select distinct d.year, d.month, d.date, 'Provider' as role, 'Other Online / Affiliate' as category, 'AllesKralle' as channel, 'Other' as vertical, 'CH' as country, 'EUR' as currency,ifnull(sum(CH_PROVIDER_ALLESKRALLE),0) as spend
  from intl.DW_MARKETING_SPEND_INTL join reporting.DW_D_DATE d on date(spend_date) = d.date where d.year >= year(now())-1 and d.date < date(current_date) group by 1,2,3,4,5,6,7,8,9
),

-- THIS IS FOR THE LIVE USD FX RATES. TOP HALF OF UNION JOIN IS BASED ON JAGAN'S MONTHLY AVERAGE FROM 2019 - 2022 SINCE THE LIVE FX TABLE IS ONLY FROM 2023.
live_fx_rates as (
select distinct year, month, date, currency,
  cast(case when year = 2022 and month = 1 and currency = 'EUR' then '1.135125807' 
            when year = 2022 and month = 2 and currency = 'EUR' then '1.132148387' 
            when year = 2022 and month = 3 and currency = 'EUR' then '1.102175' 
            when year = 2022 and month = 4 and currency = 'EUR' then '1.089916129' 
            when year = 2022 and month = 5 and currency = 'EUR' then '1.054093333' 
            when year = 2022 and month = 6 and currency = 'EUR' then '1.060787097' 
            when year = 2022 and month = 7 and currency = 'EUR' then '1.024931035' 
            when year = 2022 and month = 8 and currency = 'EUR' then '1.015929032' 
            when year = 2022 and month = 9 and currency = 'EUR' then '0.995993807' 
            when year = 2022 and month = 10 and currency = 'EUR' then '0.978726667' 
            when year = 2022 and month = 11 and currency = 'EUR' then '1.015' 
            when year = 2022 and month = 12 and currency = 'EUR' then '1.053843333'    
            when year = 2022 and month = 1 and currency = 'GBP' then '1.356309677'
            when year = 2022 and month = 2 and currency = 'GBP' then '1.352270968' 
            when year = 2022 and month = 3 and currency = 'GBP' then '1.319542857' 
            when year = 2022 and month = 4 and currency = 'GBP' then '1.304335484' 
            when year = 2022 and month = 5 and currency = 'GBP' then '1.243223333' 
            when year = 2022 and month = 6 and currency = 'GBP' then '1.239858065' 
            when year = 2022 and month = 7 and currency = 'GBP' then '1.201493103' 
            when year = 2022 and month = 8 and currency = 'GBP' then '1.205412903' 
            when year = 2022 and month = 9 and currency = 'GBP' then '1.148293129' 
            when year = 2022 and month = 10 and currency = 'GBP' then '1.117466667' 
            when year = 2022 and month = 11 and currency = 'GBP' then '1.168825807' 
            when year = 2022 and month = 12 and currency = 'GBP' then '1.216903333'   
            when year = 2022 and month = 1 and currency = 'CAD' then '0.791389836'
            when year = 2022 and month = 2 and currency = 'CAD' then '0.785626121' 
            when year = 2022 and month = 3 and currency = 'CAD' then '0.788131793' 
            when year = 2022 and month = 4 and currency = 'CAD' then '0.795315238' 
            when year = 2022 and month = 5 and currency = 'CAD' then '0.777042905' 
            when year = 2022 and month = 6 and currency = 'CAD' then '0.782231497' 
            when year = 2022 and month = 7 and currency = 'CAD' then '0.772645084' 
            when year = 2022 and month = 8 and currency = 'CAD' then '0.776468579' 
            when year = 2022 and month = 9 and currency = 'CAD' then '0.758076978' 
            when year = 2022 and month = 10 and currency = 'CAD' then '0.72823848' 
            when year = 2022 and month = 11 and currency = 'CAD' then '0.743626151' 
            when year = 2022 and month = 12 and currency = 'CAD' then '0.736560791'  
            when year = 2022 and month = 1 and currency = 'AUD' then '0.721275883'
            when year = 2022 and month = 2 and currency = 'AUD' then '0.713160948' 
            when year = 2022 and month = 3 and currency = 'AUD' then '0.734158146' 
            when year = 2022 and month = 4 and currency = 'AUD' then '0.743213151' 
            when year = 2022 and month = 5 and currency = 'AUD' then '0.703994424' 
            when year = 2022 and month = 6 and currency = 'AUD' then '0.706960713' 
            when year = 2022 and month = 7 and currency = 'AUD' then '0.684804955' 
            when year = 2022 and month = 8 and currency = 'AUD' then '0.697490292' 
            when year = 2022 and month = 9 and currency = 'AUD' then '0.658790659' 
            when year = 2022 and month = 10 and currency = 'AUD' then '0.636335818' 
            when year = 2022 and month = 11 and currency = 'AUD' then '0.656732976' 
            when year = 2022 and month = 12 and currency = 'AUD' then '0.674049273'    
      end as float) as fx_rate   
from
(select distinct
  d.year, d.month, d.date
 ,case when countrycode in ('at','be','ch','de','dk','es','fb','fi','fr','ie','nl','no','se') then 'EUR'
       when countrycode = 'uk' then 'GBP'
       when countrycode = 'ca' then 'CAD'
       when countrycode in ('au','nz') then 'AUD'
    end as currency       
 from intl.hive_member m
 join reporting.DW_D_DATE d on date(m.dateProfileComplete) = d.date 
 where d.year = 2022) fx_v1
         
union

select 
  d.year, d.month, d.date,
  source_currency as currency,
  currency_rate as fx_rate
from 
  (select 
    coalesce(fx.current_rate_date, fx_r.current_rate_date) as current_rate_date,
    coalesce(fx.source_currency, fx_r.source_currency) as source_currency,
    coalesce(fx.currency_rate, fx_r.currency_rate) as currency_rate
  from
    (
      select distinct 
        current_rate_date,
        source_currency,
        currency_rate
      from reporting.DW_CARE_FX_RATES_HISTORY
      where current_rate_date >= '2023-01-01'
      and source_currency in ('EUR','GBP','CAD','AUD') and target_currency = 'USD' 
      group by 1,2,3 order by 1 asc
    ) fx
    full outer join 
        (
        select distinct 
          (date(current_rate_date)+1) as current_rate_date, 
          source_currency, 
          currency_rate 
        from reporting.DW_CARE_FX_RATES_HISTORY 
        where current_rate_date in ('2023-03-23', '2023-05-19') and source_currency in ('EUR','GBP','CAD','AUD') and target_currency = 'USD'
        group by 1,2,3
        ) fx_r on fx.source_currency = fx_r.source_currency and fx.current_rate_date = fx_r.current_rate_date          
  group by 1,2,3) fx_daily
  join reporting.DW_D_DATE d on current_rate_date = d.date 
group by 1,2,3,4,5
),

-- THIS IS FOR THE FIXED CURRENT USD FX RATES
fixed_current_fx as (
   select distinct
    d.year, d.month, d.date,
    source_currency as currency,
    currency_rate as fx_rate
  from reporting.DW_CARE_FX_RATES fx 
  join reporting.DW_D_DATE d on current_rate_date = d.date 
  where target_currency = 'USD'
    and currency_rate_type = 'Current'
    and source_currency in ('EUR','GBP','CAD','AUD')
  group by 1,2,3,4,5
),

basics as (
	select
      d.year, d.month, d.date, 
	  initcap(m.role) as role,
	  case when (lower(m.campaign) = 'sem' or lower(m.site) = 'gdn' or lower(m.site) = 'youtube') then 'SEM' 
		   when (lower(m.site) = 'facebook' or lower(m.site) = 'pinterest') then 'Social'
		   when lower(mm.howdidyouhear) = 'tv' then 'TV'
        else 'Other Online / Affiliate' end as category,	  
	  case when lower(m.campaign) = 'sem' then 'SEM'
		   when lower(m.site) = 'gdn' then 'GDN'
		   when lower(m.site) = 'youtube' then 'YouTube'
		   when lower(m.site) = 'facebook' then 'Facebook'
		   when lower(m.site) in ('qualityclick', 'blog', 'generic', 'ortsdienst', '4everglen', 'snautz', 'marktde', 'stadtlist', 'aktuellejobs',       	'alleskralle','jobrapido', 'metajob', 'savethestudent', 'studentjob') then 'Quality Click'
		   when lower(m.site) = 'putzchecker' then 'Putzchecker'
		   when lower(m.site) = 'mibaby' then 'MiBaby'
		   when lower(m.site) in ('awin', 'zanox') then 'Awin'
		   when lower(m.site) = 'meinestadt.de' then 'Meinestadt'
		   when lower(m.site) = 'pinterest' then 'Pinterest'
		   when lower(m.site) = 'impact' then 'Impact'
		   when lower(m.site) in ('absolventen','babysitter.de','blog','careerjet','criteo','erdbeerlounge','erdbeerlounge2','gelegenheitsjobs','generic','generictotal',
            'glassdoor','jobrobot','mapmeo','marktde','marktplaats','metajob','mitula','nannytax','njobs','palkkausfi','provider','qualityclick','quoka',
            'rabathelten','recrudo','rubrikk','savethestudent','so.dk','stadtlist','stellenwerk','studiumratgeber','meinestadt','aktuellejobs','jobkicks') then 'QualityClick'
		   when lower(m.site) in ('adzuna','adzunaauto','allthetopbananas','indeed','indeedauto','jobisj','jobisjob','jobisjobauto','jobisjobde',
           'jobisjobdeauto','jobrapido','jobrapidoauto','jobrapidoleads','jooble','joobleauto','jorapaid','neuvoo','trovit','trovitde','trovitdeauto',
           'trovituk','trovituksauto','ziprecruiter','reach','monster') then 'Recruitics'
		   when lower(m.site) = 'studentjob' then 'StudentJob'
		   when lower(m.site) = 'appjobs' then 'AppJobs'
		   when lower(m.site) = 'appcast' then 'AppCast'
		   when lower(m.site) = 'myperfectjob' then 'MyPerfectJob'
		   when lower(m.site) = 'joblift' then 'JobLift'
		   when lower(m.site) = 'alleskralle' then 'AllesKralle'
		 end as channel,  
		   
      upper(m.countrycode) as country,  
      
	  count(distinct mm.memberid) as basics  

    from intl.hive_member m   
    join reporting.DW_D_DATE d on date(m.dateMemberSignup) = dd.date 
    where (lower(campaign) = 'sem' 
            or lower(site) in ('facebook', 'youtube', 'gdn', 'meinestadt.de', 'qualityclick', 'blog', 'generic', 'ortsdienst', '4everglen', 'snautz', 'marktde', 'stadtlist', 'aktuellejobs', 'alleskralle', 'jobrapido', 'metajob', 
                                'savethestudent', 'studentjob', 'putzchecker', 'awin', 'zanox', 'pinterest', 'impact', 'mibaby'))
      and IsInternalAccount = 'false'
      and d.year >= year(now())-1 
      and d.date < date(current_date)
    group by 1,2,3,4,5,6 
),

premiums as (
 select
      dd.year, dd.month, dd.date, 
      upper(m.countrycode) as country,
      case when lower(m.site) in ('qualityclick', 'blog', 'generic', 'ortsdienst', '4everglen', 'snautz', 'marktde', 'stadtlist', 'aktuellejobs', 'alleskralle', 'jobrapido', 'metajob', 'savethestudent', 'studentjob', 'putzchecker', 'awin', 'zanox', 'pinterest', 'impact', 'mibaby') then 'Brand'
           when lower(m.service) in ('br', 'all') then 'Brand'
           when (lower(m.service) not in ('br', 'all') and mm.vertical = 'homeCare') then 'Housekeeping' 
           when (lower(m.service) not in ('br', 'all') and (mm.vertical is null or mm.vertical = '')) then 'Childcare' 
        else initcap(lower(m.vertical)) end as vertical, 
      case when lower(m.campaign) = 'sem' then 'SEM' 
           when lower(m.site) = 'facebook' then 'Facebook'
           when lower(m.site) = 'gdn' then 'GDN'
           when lower(m.site) = 'youtube' then 'YouTube'
           when lower(m.site) = 'meinestadt.de' then 'Meinestadt'
           when lower(m.site) in ('qualityclick', 'blog', 'generic', 'ortsdienst', '4everglen', 'snautz', 'marktde', 'stadtlist', 'aktuellejobs', 'alleskralle', 'jobrapido', 'metajob', 'savethestudent', 'studentjob') then 'Quality Click'
           when lower(m.site) in ('awin', 'zanox') then 'Awin'
           when lower(m.site) = 'putzchecker' then 'Putzchecker'
           when lower(m.site) = 'pinterest' then 'Pinterest'
           when lower(m.site) = 'impact' then 'Impact'
           when lower(m.site) = 'mibaby' then 'MiBaby'
        end as channel,        
     count(distinct sp.subscriptionId) as premiums,
     count(distinct case when date(sp.subscriptionDateCreated) = date(m.dateProfileComplete) then sp.subscriptionId end) as day1s,
     count(distinct case when date(m.dateFirstPremiumSignup) = date(sp.subscriptionDateCreated) and date(sp.subscriptionDateCreated) != date(m.dateMemberSignup) then sp.subscriptionId end) as nths,
     count(distinct case when date(m.dateFirstPremiumSignup) != date(sp.subscriptionDateCreated) then sp.subscriptionId end) as reupgrades     
    from intl.transaction tt
      join intl.hive_subscription_plan sp on sp.subscriptionId = tt.subscription_plan_id and sp.countrycode = tt.country_code
      join reporting.DW_D_DATE dd         on date(sp.subscriptionDateCreated) = dd.date 
      join intl.hive_member m            on tt.member_id = mm.memberid and tt.country_code = mm.countrycode
   where tt.type in ('PriorAuthCapture','AuthAndCapture')
      and tt.status = 'SUCCESS'
      and tt.amount > 0
      and mm.IsInternalAccount = 'false'
      and lower(m.role) = 'seeker'
      and (lower(campaign) = 'sem' or lower(site) in ('facebook', 'youtube', 'gdn', 'meinestadt.de', 'qualityclick', 'blog', 'generic', 'ortsdienst', '4everglen', 'snautz', 'marktde', 'stadtlist', 'aktuellejobs', 'alleskralle', 'jobrapido', 'metajob', 'savethestudent', 'studentjob', 'putzchecker', 'awin', 'zanox', 'pinterest', 'impact', 'mibaby'))
      and dd.year >= year(now())-1
      and dd.date < date(current_date)
  group by 1,2,3,4,5,6
)

select distinct
  coalesce(sp.year,fx.year) as year, 
  coalesce(sp.month,fx.month) as month, 
  cur.Current_Date_SameDay as date_current, 
  coalesce(sp.date,fx.date) as date,
  sp.role, sp.category, sp.channel, sp.vertical, sp.country,
  coalesce(sp.currency,fx.currency) as currency, 
  fx.fx_rate,
  cfx.fx_rate as current_fixed_fx_rate,
  ifnull(sum(sp.spend),0) as spend_domestic,
  ifnull(sum(case when sp.currency = 'EUR' then sp.spend * fx.fx_rate
                  when sp.currency = 'GBP' then sp.spend * fx.fx_rate
                  when sp.currency = 'CAD' then sp.spend * fx.fx_rate  
                  when sp.currency = 'AUD' then sp.spend * fx.fx_rate end),0) as spend_live_fx_usd,
  ifnull(sum(case when sp.currency = 'EUR' then sp.spend * cfx.fx_rate
                  when sp.currency = 'GBP' then sp.spend * cfx.fx_rate
                  when sp.currency = 'CAD' then sp.spend * cfx.fx_rate  
                  when sp.currency = 'AUD' then sp.spend * cfx.fx_rate end),0) as spend_fixed_current_fx_usd
                  
from spend sp
join analytics.DW_D_DATE_CURRENT cur             on sp.date = cur.date 
left join live_fx_rates fx                       on sp.currency = fx.currency and sp.year = fx.year and sp.month = fx.month and sp.week_start_date = fx.week_start_date and sp.date = fx.date 
left join fixed_current_fx cfx                   on sp.currency = cfx.currency

group by 1,2,3,4,5,6,7,8,9,10,11,12,13
order by 1,2,3,4,5 desc

